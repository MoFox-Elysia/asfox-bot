name: Build Android APK (Fixed)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install Cython==0.29.33 buildozer==1.5.0 python-for-android==2024.1.21

    - name: Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq \
          build-essential git ffmpeg \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev \
          zlib1g-dev libgstreamer1.0-dev gstreamer1.0-plugins-base gstreamer1.0-plugins-good \
          autoconf libtool pkg-config \
          libncurses5-dev libncursesw5-dev libtinfo-dev cmake \
          libffi-dev libssl-dev automake zip unzip \
          openjdk-17-jdk python3-dev \
          libjpeg-dev libpng-dev libfreetype6-dev libsqlite3-dev \
          libbz2-dev libxml2-dev liblzma-dev \
          m4 bison flex gperf lld clang libc++-dev libc++abi-dev libtool-bin \
          wget unzip curl \
          > /dev/null 2>&1 || echo "Some packages failed to install, continuing..."

    - name: Setup Android SDK and NDK
      run: |
        # 创建必要的目录
        mkdir -p ~/.buildozer/android/platform
        
        # 下载并设置 Android SDK
        echo "Setting up Android SDK..."
        cd ~/.buildozer/android/platform
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
        unzip -q cmdline-tools.zip
        rm cmdline-tools.zip
        mkdir -p android-sdk/cmdline-tools
        mv cmdline-tools android-sdk/cmdline-tools/latest
        
        # 设置环境变量
        export ANDROID_SDK_ROOT=~/.buildozer/android/platform/android-sdk
        export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH
        
        # 下载 Android NDK
        echo "Downloading Android NDK..."
        wget -q https://dl.google.com/android/repository/android-ndk-r25b-linux.zip -O android-ndk-r25b-linux.zip
        unzip -q android-ndk-r25b-linux.zip
        rm android-ndk-r25b-linux.zip
        mv android-ndk-r25b android-ndk-r25b
        
        # 接受许可证
        echo "Accepting Android SDK licenses..."
        mkdir -p $ANDROID_SDK_ROOT/licenses
        echo "89316a2ffe0e01b6d91f2f87be9676f5e584ddc6" > $ANDROID_SDK_ROOT/licenses/android-sdk-license
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
        echo "d56f5187479451eabf01fb78af6dfcb131a6481e" > $ANDROID_SDK_ROOT/licenses/android-sdk-preview-license
        
        echo "Android SDK and NDK setup completed"

    - name: Build APK with Buildozer
      run: |
        # 设置环境变量
        export ANDROID_SDK_ROOT=~/.buildozer/android/platform/android-sdk
        export ANDROID_NDK_HOME=~/.buildozer/android/platform/android-ndk-r25b
        export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH
        
        echo "Starting Buildozer build..."
        buildozer android debug 2>&1 | tee build.log
        
        # 检查构建是否成功
        if [ -f bin/*.apk ]; then
          echo "APK build successful!"
          ls -lh bin/*.apk
        else
          echo "APK build failed. Check build.log for details."
          tail -100 build.log
          exit 1
        fi

    - name: Find and display APK files
      run: |
        mkdir -p artifacts/
        find . -type f -name "*.apk" 2>/dev/null -exec cp {} artifacts/ \;
        ls -lh artifacts/*.apk 2>/dev/null || echo "No APK files found in artifacts"

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: artifacts/*.apk
        retention-days: 30
        if-no-files-found: warn

    - name: Upload build log
      uses: actions/upload-artifact@v4
      with:
        name: build-log
        path: build.log
        retention-days: 7
        if-no-files-found: warn
