name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install Cython buildozer python-for-android

    - name: Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq \
          build-essential git ffmpeg \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev \
          zlib1g-dev libgstreamer1.0-dev gstreamer1.0-plugins-base gstreamer1.0-plugins-good \
          autoconf libtool pkg-config \
          libncurses5-dev libncursesw5-dev libtinfo-dev cmake \
          libffi-dev libssl-dev automake zip unzip \
          openjdk-17-jdk python3-dev \
          libjpeg-dev libpng-dev libfreetype6-dev libsqlite3-dev \
          libbz2-dev libxml2-dev liblzma-dev \
          m4 bison flex gperf lld clang libc++-dev libc++abi-dev libtool-bin \
          > /dev/null 2>&1 || echo "Some packages failed to install, continuing..."

    - name: Fix libtool for libffi compatibility
      run: |
        sudo mkdir -p /usr/share/aclocal
        sudo apt-get install -y -qq libtool-bin > /dev/null 2>&1 || true
        sudo find /usr -name "libtool.m4" 2>/dev/null | head -n 1 | xargs -I {} sudo ln -sf {} /usr/share/aclocal/ 2>/dev/null || true
        if [ -f /usr/share/libtool/build-aux/ltmain.sh ]; then
          sudo ln -sf /usr/share/libtool/build-aux/ltmain.sh /usr/share/libtool/config/ltmain.sh 2>/dev/null || true
        fi

    - name: Patch libffi autogen.sh
      run: |
        # 创建补丁目录
        sudo mkdir -p /opt/libffi-patch

        # 创建修复后的 autogen.sh
        sudo tee /opt/libffi-patch/autogen.sh > /dev/null << 'EOF'
#!/bin/sh
# Run autoreconf to generate build files.

set -x

if [ "$#" -ne 0 ]; then
  echo "Usage: $0" 1>&2
  exit 1
fi

autoreconf --install --force --verbose
EOF

        sudo chmod +x /opt/libffi-patch/autogen.sh

    - name: Set up Buildozer environment
      run: |
        mkdir -p .buildozer
        echo -e "[app]\ntitle = 错题整理软件\npackage.name = errorquestion\npackage.domain = org.errorquestion\nsource.dir = .\nsource.include_exts = py,png,jpg,kv,atlas,txt\nversion = 1.0.0\nrequirements = python3,kivy,pillow,fpdf2,pyjnius,plyer,cython,pyopenssl\norientation = portrait\nfullscreen = 0\nandroid.minapi = 21\nandroid.api = 33\nandroid.ndk_api = 21\nandroid.permissions = CAMERA,WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE\nandroid.features = android.hardware.camera\nandroid.min_sdk = 21\nandroid.archs = arm64-v8a\nandroid.enable_androidx = True\nandroid.entrypoint = org.kivy.android.PythonActivity\n\n[buildozer]\nlog_level = 2\nwarn_on_root = 1" > buildozer.spec

    - name: Cache Buildozer
      uses: actions/cache@v4
      with:
        path: |
          .buildozer
          ~/.buildozer
        key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-

    - name: Clean build environment
      run: |
        rm -rf .buildozer 2>/dev/null || true

    - name: Build APK with Buildozer
      run: |
        buildozer android debug 2>&1 | tee build.log
      continue-on-error: false

    - name: Find and display APK files
      run: |
        mkdir -p bin/
        find . -type f -name "*.apk" 2>/dev/null -exec cp {} bin/ \;
        ls -lh bin/*.apk 2>/dev/null || echo "No APK files found"

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: ./bin/*.apk
        retention-days: 30
        if-no-files-found: warn

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: bin/*.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
