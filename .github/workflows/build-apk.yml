name: Build Android APK (Simple)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'  # 使用更稳定的Python 3.10
        cache: 'pip'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install Cython==0.29.33 buildozer==1.5.0 python-for-android==2024.1.21

    - name: Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq \
          build-essential git ffmpeg \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev \
          zlib1g-dev libgstreamer1.0-dev gstreamer1.0-plugins-base gstreamer1.0-plugins-good \
          autoconf libtool pkg-config \
          libncurses5-dev libncursesw5-dev libtinfo-dev cmake \
          libffi-dev libssl-dev automake zip unzip \
          openjdk-17-jdk python3-dev \
          libjpeg-dev libpng-dev libfreetype6-dev libsqlite3-dev \
          libbz2-dev libxml2-dev liblzma-dev \
          m4 bison flex gperf lld clang libc++-dev libc++abi-dev libtool-bin \
          > /dev/null 2>&1 || echo "Some packages failed to install, continuing..."

    - name: Pre-download Android SDK
      run: |
        mkdir -p ~/.buildozer/android/platform
        cd ~/.buildozer/android/platform
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
        unzip -q cmdline-tools.zip
        mv cmdline-tools cmdline-tools-latest
        mkdir -p cmdline-tools-latest/bin
        echo "Android SDK downloaded"

    - name: Accept Android SDK Licenses
      run: |
        mkdir -p ~/.buildozer/android/platform/android-sdk/licenses
        echo "89316a2ffe0e01b6d91f2f87be9676f5e584ddc6" > ~/.buildozer/android/platform/android-sdk/licenses/android-sdk-license
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" >> ~/.buildozer/android/platform/android-sdk/licenses/android-sdk-license
        echo "d56f5187479451eabf01fb78af6dfcb131a6481e" > ~/.buildozer/android/platform/android-sdk/licenses/android-sdk-preview-license

    - name: Build APK with Buildozer
      run: |
        buildozer android debug 2>&1 | tee build.log
      continue-on-error: false

    - name: Find and display APK files
      run: |
        mkdir -p bin/
        find . -type f -name "*.apk" 2>/dev/null -exec cp {} bin/ \;
        ls -lh bin/*.apk 2>/dev/null || echo "No APK files found"

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: ./bin/*.apk
        retention-days: 30
        if-no-files-found: warn

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: bin/*.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
